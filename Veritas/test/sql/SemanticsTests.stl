module sql.SemanticsTests

import sql.BasicFunctions
import sql.Semantics
import sql.Tables
import sql.TableAux
import sql.Syntax
import sql.TStore

local {
	constructors 
		x1 : FVal
		x2 : FVal
		y1 : FVal
		y2 : FVal
		z1 : FVal
		z2 : FVal
		
	constructors
		TN : TName
		A1 : AName
		A2 : AName
		A3 : AName

	goal
	~al == acons(A1, acons(A2, acons(A3, aempty)))
	~rt == ttcons(rcons(x1, rcons(y2, rcons(z2, rempty))), 
		tcons(rcons(x2, rcons(y1, rcons(z1, rempty))), tempty))
	~t == table(~al, ~rt)
	~ts == bind(TN, ~t, empty)
	~q == SelectAll(TN)
	========================================================== test-selectall1
	reduce(conf(~q, ~ts)) == some(conf(TValue(~t), ~ts))
}

local {
	constructors 
		x1 : FVal
		x2 : FVal
		y1 : FVal
		y2 : FVal
		z1 : FVal
		z2 : FVal
		
	constructors
		A1 : AName
		A2 : AName
		A3 : AName

	goal
	~al == acons(A1, acons(A2, acons(A3, aempty)))
	~rt == tcons(rcons(x1, rcons(y2, rcons(z2, rempty))), 
		tcons(rcons(x2, rcons(y1, rcons(z1, rempty))), tempty))
	~t == table(~al, ~rt)
	~tresult == tcons(rcons(x1, rempty), tcons(rcons(x2, rempty), tempty))
	=================================================================================== test-projection1
	project(acons(A1, aempty), ~t) == some(~tresult)
}



local {
	constructors 
		x1 : FVal
		x2 : FVal
		y1 : FVal
		y2 : FVal
		z1 : FVal
		z2 : FVal
		
	constructors
		TN : TName
		A1 : AName
		A2 : AName
		A3 : AName	

	goal
	~al == acons(A1, acons(A2, acons(A3, aempty)))
	~rt == tcons(rcons(x1, rcons(y2, rcons(z2, rempty))), 
		tcons(rcons(x2, rcons(y1, rcons(z1, rempty))), tempty))
	~t == table(~al, ~rt)
	~ts == bind(TN, ~t, empty)
	~q == SelectFrom1(acons(A1, aempty), TN)
	~tresult == table(acons(A1, aempty), tcons(rcons(x1, rempty), tcons(rcons(x2, rempty), tempty)))
	================================================================================================== test-selectfrom1
	reduce(conf(~q, ~ts)) == some(conf(TValue(~tresult), ~ts))
}


local {
	constructors 
		x1 : FVal
		x2 : FVal
		y1 : FVal
		y2 : FVal
		z1 : FVal
		z2 : FVal
		
	constructors
		A1 : AName
		A2 : AName
		A3 : AName

	goal
	~al == acons(A1, acons(A2, acons(A3, aempty)))
	~rt == tcons(rcons(x1, rcons(y2, rcons(z2, rempty))), 
		tcons(rcons(x2, rcons(y1, rcons(z1, rempty))), tempty))
	~t == table(~al, ~rt)
	~tresult == table(acons(A2, aempty), tcons(rcons(y2, rempty), tcons(rcons(y1, rempty), tempty)))
	=================================================================================== test-projection2
	project(acons(A2, aempty), ~t) == some(~tresult)
}

local {
	constructors
		x1 : FVal
		x2 : FVal
		y1 : FVal
		y2 : FVal
		z1 : FVal
		z2 : FVal
		
	constructors
		TN : TName
		A1 : AName
		A2 : AName
		A3 : AName
		
	goal
	~al == acons(A1, acons(A2, acons(A3, aempty)))
	~rt == tcons(rcons(x1, rcons(y2, rcons(z2, rempty))), 
		tcons(rcons(x2, rcons(y1, rcons(z1, rempty))), tempty))
	~t == table(~al, ~rt)
	~tresult == tcons(rcons(y2, rempty), tcons(rcons(y1, rempty), tempty))
	================================================================================================ prt-aux1
	getSome(project(acons(A2, aempty), ~t)) == ~tresult

	axiom
	~al == acons(A1, acons(A2, acons(A3, aempty)))
	~rt == tcons(rcons(x1, rcons(y2, rcons(z2, rempty))), 
		tcons(rcons(x2, rcons(y1, rcons(z1, rempty))), tempty))
	~t == table(~al, ~rt)
	~tresult == tcons(rcons(y2, rempty), tcons(rcons(y1, rempty), tempty))
	================================================================================================ prt-aux1
	getSome(project(acons(A2, aempty), ~t)) == ~tresult
			
	goal
	~al == acons(A1, acons(A2, acons(A3, aempty)))
	~rt == tcons(rcons(x1, rcons(y2, rcons(z2, rempty))), 
		tcons(rcons(x2, rcons(y1, rcons(z1, rempty))), tempty))
	~t == table(~al, ~rt)
	~tresult == tcons(rcons(x1, rempty), tcons(rcons(x2, rempty), tempty))
	=================================================================================== prt-aux2
	getSome(project(acons(A1, aempty), ~t)) == ~tresult
	
	axiom
	~al == acons(A1, acons(A2, acons(A3, aempty)))
	~rt == tcons(rcons(x1, rcons(y2, rcons(z2, rempty))), 
		tcons(rcons(x2, rcons(y1, rcons(z1, rempty))), tempty))
	~t == table(~al, ~rt)
	~tresult == tcons(rcons(x1, rempty), tcons(rcons(x2, rempty), tempty))
	=================================================================================== prt-aux2
	getSome(project(acons(A1, aempty), ~t)) == ~tresult
	
	goal
	~tresult1 == table(acons(A2, aempty), tcons(rcons(y2, rempty), tcons(rcons(y1, rempty), tempty)))
	~tresult2 == table(acons(A1, aempty), tcons(rcons(x1, rempty), tcons(rcons(x2, rempty), tempty)))
	~rtresult == tcons(rcons(y2, rcons(x1, rempty)), tcons(rcons(y1, rcons(x2, rempty)), tempty))
	=================================================================================================== prt-aux3
	attachColToFrontRaw(getRaw(~tresult1), getRaw(~tresult2)) == ~rtresult
	
	goal
	~tresult1 == table(acons(A2, aempty), tcons(rcons(y2, rempty), tcons(rcons(y1, rempty), tempty)))
	~tresult2 == table(acons(A1, aempty), tcons(rcons(x1, rempty), tcons(rcons(x2, rempty), tempty)))
	~rtresult == tcons(rcons(y2, rcons(x1, rempty)), tcons(rcons(y1, rcons(x2, rempty)), tempty))
	=================================================================================================== prt-aux3
	attachColToFrontRaw(getRaw(~tresult1), getRaw(~tresult2)) == ~rtresult

	goal
	~al == acons(A1, acons(A2, acons(A3, aempty)))
	~rt == tcons(rcons(x1, rcons(y2, rcons(z2, rempty))), 
		tcons(rcons(x2, rcons(y1, rcons(z1, rempty))), tempty))
	~t == table(~al, ~rt)
	~tresult == tcons(rcons(y2, rcons(x1, rempty)), tcons(rcons(y1, rcons(x2, rempty)), tempty))
	============================================================================================= test-projection3
	getSome(project(acons(A2, acons(A1, aempty)), ~t)) == ~tresult
}

local {
	constructors 
		x1 : FVal
		x2 : FVal
		y1 : FVal
		y2 : FVal
		z1 : FVal
		z2 : FVal
		
	constructors
		TN : TName
		A1 : AName
		A2 : AName
		A3 : AName
		
	axiom
	~al == acons(A1, acons(A2, acons(A3, aempty)))
	~rt == tcons(rcons(x1, rcons(y2, rcons(z2, rempty))), 
		tcons(rcons(x2, rcons(y1, rcons(z1, rempty))), tempty))
	~t == table(~al, ~rt)
	~tresult == tcons(rcons(y2, rcons(x1, rempty)), tcons(rcons(y1, rcons(x2, rempty)), tempty))
	============================================================================================= test-projection3
	getSome(project(acons(A2, acons(A1, aempty)), ~t)) == ~tresult

	goal
	~al == acons(A1, acons(A2, acons(A3, aempty)))
	~rt == tcons(rcons(x1, rcons(y2, rcons(z2, rempty))), 
		tcons(rcons(x2, rcons(y1, rcons(z1, rempty))), tempty))
	~t == table(~al, ~rt)
	~ts == bind(TN, ~t, empty)
	~q == SelectFrom1(acons(A2, acons(A1, aempty)), TN)
	~tresult == table(acons(A2, acons(A1, aempty)), 
		tcons(rcons(y2, rcons(x1, rempty)), tcons(rcons(y1, rcons(x2, rempty)), tempty)))
	======================================================================================= test-selectfrom1-2
	reduce(conf(~q, ~ts)) == some(conf(TValue(~tresult), ~ts))
}

// 
// // local {
// // 	consts 
// // 		x1 : FVar
// // 		x2 : FVar
// // 		y1 : FVar
// // 		y2 : FVar
// // 		z1 : FVar
// // 		z2 : FVar
// // 		
// // 	consts
// // 		TN : TName
// // 		A1 : AName
// // 		A2 : AName
// // 		A3 : AName
// // 		FT1 : FType
// // 		FT2 : FType
// // 		FT3 : FType
// // 		
// // 	axiom
// // 	
// // 	===================== ft-x1
// // 	fieldType(x1) = FT1
// // 	
// // 	// axiom
// // 	// 
// // 	// ===================== ft-x2
// // 	// fieldType(x2) = FT1
// // 	// 
// // 	// axiom
// // 	// 
// // 	// ===================== ft-y1
// // 	// fieldType(y1) = FT2
// // 	// 
// // 	// axiom
// // 	// 
// // 	// ===================== ft-y2
// // 	// fieldType(y2) = FT2
// // 	// 
// // 	// axiom
// // 	// 
// // 	// ===================== ft-z1
// // 	// fieldType(z1) = FT3
// // 	// 
// // 	// axiom
// // 	// 
// // 	// ===================== ft-z2
// // 	// fieldType(z2) = FT3
// // 		
// // 	goal
// // 	~tt == ttmany(ctype(A1, FT1), ttmany(ctype(A2, FT2), ttone(ctype(A3, FT3))))
// // 	~r == rmany(x1, rmany(y2, rone(z2)))
// // 	=============================================================================== singleRow-aux1
// // 	singleRowSelection(~tt, VEquals(A1, x1), ~r) == isTrue
// // 	
// // 	axiom
// // 	~tt == ttmany(ctype(A1, FT1), ttmany(ctype(A2, FT2), ttone(ctype(A3, FT3))))
// // 	~r == rmany(x1, rmany(y2, rone(z2)))
// // 	=============================================================================== singleRow-aux1
// // 	singleRowSelection(~tt, VEquals(A1, x1), ~r) == isTrue
// // 	
// // 	goal
// // 	~tt == ttmany(ctype(A1, FT1), ttmany(ctype(A2, FT2), ttone(ctype(A3, FT3))))
// // 	~r == rmany(x2, rmany(y1, rone(z1)))
// // 	=============================================================================== singleRow-aux2
// // 	singleRowSelection(~tt, VEquals(A1, x1), ~r) == isFalse
// // 	
// // 	axiom
// // 	~tt == ttmany(ctype(A1, FT1), ttmany(ctype(A2, FT2), ttone(ctype(A3, FT3))))
// // 	~r == rmany(x2, rmany(y1, rone(z1)))
// // 	=============================================================================== singleRow-aux2
// // 	singleRowSelection(~tt, VEquals(A1, x1), ~r) == isFalse
// // 	
// // 	goal
// // 	~tt == ttmany(ctype(A1, FT1), ttmany(ctype(A2, FT2), ttone(ctype(A3, FT3))))
// // 	============================================================================= checkPValidity-aux
// // 	checkPValidity(VEquals(A1, x1), ~tt)
// // 	
// // 	axiom
// // 	~tt == ttmany(ctype(A1, FT1), ttmany(ctype(A2, FT2), ttone(ctype(A3, FT3))))
// // 	============================================================================= checkPValidity-aux
// // 	checkPValidity(VEquals(A1, x1), ~tt)
// // 
// // 	goal
// // 	~tt == ttmany(ctype(A1, FT1), ttmany(ctype(A2, FT2), ttone(ctype(A3, FT3))))
// // 	~rt == tmany(rmany(x1, rmany(y2, rone(z2))), 
// // 		tmany(rmany(x2, rmany(y1, rone(z1))), tempty))
// // 	~t == table(~tt, ~rt)
// // 	~tresult == table(~tt, tmany(rmany(x1, rmany(y2, rone(z2))), tempty))
// // 	=================================================================================== test-selection1
// // 	selection(~t, VEquals(A1, x1)) == some(~tresult)
// // }
// // 
// // 
// // local {
// // 	consts 
// // 		x1 : FVar
// // 		x2 : FVar
// // 		y1 : FVar
// // 		y2 : FVar
// // 		z1 : FVar
// // 		z2 : FVar
// // 		
// // 	consts
// // 		TN : TName
// // 		A1 : AName
// // 		A2 : AName
// // 		A3 : AName
// // 		FT1 : FType
// // 		FT2 : FType
// // 		FT3 : FType
// // 	
// // 	//needs 120 timeout!	
// // 	goal
// // 	~rt1 == tmany(rmany(x1, rmany(y2, rone(z2))), 
// // 		tmany(rmany(x2, rmany(y1, rone(z1))), tempty))
// // 	~rt2 == tmany(rmany(x2, rmany(y1, rone(z2))), 
// // 		tmany(rmany(x2, rmany(y1, rone(z2))), tempty))
// // 	~rtresult == tmany(rmany(x1, rmany(y2, rone(z2))), 
// // 		tmany(rmany(x2, rmany(y1, rone(z1))), 
// // 		tmany(rmany(x2, rmany(y1, rone(z2))), 
// // 		tmany(rmany(x2, rmany(y1, rone(z2))), tempty))))
// // 	===================================================== rawUnion-aux
// // 	rawUnion(~rt1, ~rt2) == ~rtresult
// // 	
// // 	axiom
// // 	~rt1 == tmany(rmany(x1, rmany(y2, rone(z2))), 
// // 		tmany(rmany(x2, rmany(y1, rone(z1))), tempty))
// // 	~rt2 == tmany(rmany(x2, rmany(y1, rone(z2))), 
// // 		tmany(rmany(x2, rmany(y1, rone(z2))), tempty))
// // 	~rtresult == tmany(rmany(x1, rmany(y2, rone(z2))), 
// // 		tmany(rmany(x2, rmany(y1, rone(z1))), 
// // 		tmany(rmany(x2, rmany(y1, rone(z2))), 
// // 		tmany(rmany(x2, rmany(y1, rone(z2))), tempty))))
// // 	===================================================== rawUnion-aux
// // 	rawUnion(~rt1, ~rt2) == ~rtresult
// // 	
// // 	goal
// // 	~tt == ttmany(ctype(A1, FT1), ttmany(ctype(A2, FT2), ttone(ctype(A3, FT3))))
// // 	~rt1 == tmany(rmany(x1, rmany(y2, rone(z2))), 
// // 		tmany(rmany(x2, rmany(y1, rone(z1))), tempty))
// // 	~rt2 == tmany(rmany(x2, rmany(y1, rone(z2))), 
// // 		tmany(rmany(x2, rmany(y1, rone(z2))), tempty))
// // 	~rtresult == tmany(rmany(x1, rmany(y2, rone(z2))), 
// // 		tmany(rmany(x2, rmany(y1, rone(z1))), 
// // 		tmany(rmany(x2, rmany(y1, rone(z2))), 
// // 		tmany(rmany(x2, rmany(y1, rone(z2))), tempty))))
// // 	~t1 == table(~tt, ~rt1)
// // 	~t2 == table(~tt, ~rt2)
// // 	~ts == bind(TN, ~t, empty)
// // 	~q == Union(TValue(~t1), TValue(~t2))
// // 	~t == table(~tt, ~rtresult)
// // 	============================================================================== test-union1
// // 	reduce(conf(~q, ~ts)) == some(conf(TValue(~t), ~ts))
// // }
// // 
// // 
// // local {
// // 	consts 
// // 		x1 : FVar
// // 		x2 : FVar
// // 		y1 : FVar
// // 		y2 : FVar
// // 		z1 : FVar
// // 		z2 : FVar
// // 		
// // 	consts
// // 		TN : TName
// // 		A1 : AName
// // 		A2 : AName
// // 		A3 : AName
// // 		FT1 : FType
// // 		FT2 : FType
// // 		FT3 : FType
// // 		
// // 	//this goal somehow cannot be proven
// // 	//probably tables with 3 cols are too difficult?
// // 	// goal
// // 	// ~rt1 == tmany(rmany(x1, rmany(y2, rone(z2))), 
// // 	// 	tmany(rmany(x2, rmany(y1, rone(z1))), tempty))
// // 	// ~rt2 == tmany(rmany(x2, rmany(y1, rone(z2))), 
// // 	// 	tmany(rmany(x2, rmany(y1, rone(z2))), tempty))
// // 	// ===================================================== rawIntersection-aux
// // 	// rawIntersection(~rt1, ~rt2) == tempty
// // 	
// // 	axiom
// // 	~rt1 == tmany(rmany(x1, rmany(y2, rone(z2))), 
// // 		tmany(rmany(x2, rmany(y1, rone(z1))), tempty))
// // 	~rt2 == tmany(rmany(x2, rmany(y1, rone(z2))), 
// // 		tmany(rmany(x2, rmany(y1, rone(z2))), tempty))
// // 	===================================================== rawIntersection-aux
// // 	rawIntersection(~rt1, ~rt2) == tempty
// // 	
// // 	goal
// // 	~tt == ttmany(ctype(A1, FT1), ttmany(ctype(A2, FT2), ttone(ctype(A3, FT3))))
// // 	~rt1 == tmany(rmany(x1, rmany(y2, rone(z2))), 
// // 		tmany(rmany(x2, rmany(y1, rone(z1))), tempty))
// // 	~rt2 == tmany(rmany(x2, rmany(y1, rone(z2))), 
// // 		tmany(rmany(x2, rmany(y1, rone(z2))), tempty))
// // 	~t1 == table(~tt, ~rt1)
// // 	~t2 == table(~tt, ~rt2)
// // 	~ts == bind(TN, ~t, empty)
// // 	~q == Intersection(TValue(~t1), TValue(~t2))
// // 	~t == table(~tt, tempty)
// // 	============================================================================== test-intersection1
// // 	reduce(conf(~q, ~ts)) == some(conf(TValue(~t), ~ts))
// // }
// // 
// // 
