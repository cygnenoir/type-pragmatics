module sql.Preservation

import sql.BasicFunctions
import sql.Syntax
import sql.Semantics
import sql.TypeSystem
import sql.TStore
import sql.Tables
import sql.TableAux
import sql.SoundnessAuxDefs
import sql.PreservationProjection

goal 
~qi == Tvalue(~t)
~cin == conf(~qi, ~TS)
~cout == conf(~qo, ~TS)
reduce(~cin) = some(~cout)
~TTC |- ~qi : ~TT
StoreContextConsistent(~TS, ~TTC)
=================================== SQL-Preservation-T-Tvalue
~TTC |- ~qo : ~TT


goal 
~qi == Selectallfrom(Ref(~tn))
~cin == conf(~qi, ~TS)
~cout == conf(~qo, ~TS)
reduce(~cin) = some(~cout)
~TTC |- ~qi : ~TT
StoreContextConsistent(~TS, ~TTC)
=================================== SQL-Preservation-T-Selectallfrom
~TTC |- ~qo : ~TT

goal 
~qi == Selectsomefrom(~al, Ref(~tn))
~cin == conf(~qi, ~TS)
~cout == conf(~qo, ~TS)
reduce(~cin) = some(~cout)
~TTC |- ~qi : ~TT
StoreContextConsistent(~TS, ~TTC)
=================================== SQL-Preservation-T-Selectsomefrom
~TTC |- ~qo : ~TT


// 
// // goal 
// // ~sqli == SelectAllFromWhere1(~tn, ~p)
// // ~cin == conf(~sqli, ~TS)
// // ~cout == conf(~sqlo, ~TS)
// // reduce(~cin) = some(~cout)
// // ~TS |- ~sqli : ~TT
// // ================================ SQL-Preservation-T-SelectAllFromWhere1
// // ~TS |- ~sqlo : ~TT
// 
// 
// // goal 
// // ~sqli == SelectFromWhere1(~TT, ~tn, ~p)
// // ~cin == conf(~sqli, ~TS)
// // ~cout == conf(~sqlo, ~TS)
// // reduce(~cin) = some(~cout)
// // ~TS |- ~sqli : ~TT
// // ================================ SQL-Preservation-T-SelectFromWhere1
// // ~TS |- ~sqlo : ~TT
// 
local {
	consts q1 : Query
		q2 : Query
		TS : TStore
		TTC : TTContext
		TT : TType
	
	local {
	
		axiom
		~TTC |- Tvalue(~t1) : ~TT
		~TTC |- Tvalue(~t2) : ~TT
		================================================ Union-type-aux
		~TTC |- Tvalue(getSome(Union(~t1, ~t2))) : ~TT
		
		goal
		~qi == Union(Tvalue(~t1), Tvalue(~t2))
		~cin == conf(~qi, TS)
		~cout == conf(~qo, TS)
		reduce(~cin) = some(~cout)
		TTC |- ~qi : TT
		StoreContextConsistent(~TS, ~TTC)
		========================================== SQL-Preservation-T-Union-1
		TS |- ~qo : TT
	}	
		
	axiom 
	~qi == Union(Tvalue(~t1), Tvalue(~t2))
	~cin == conf(~qi, TS)
	~cout == conf(~qo, TS)
	reduce(~cin) = some(~cout)
	TTC |- ~qi : TT
	StoreContextConsistent(~TS, ~TTC)
	========================================== SQL-Preservation-T-Union-1
	TS |- ~qo : TT	
	
	local {

		axiom
		~qi == Union(Tvalue(~t1), q2)
		forall ~t2 q2 != Tvalue(~t2)
		~cin == conf(~qi, TS)
		~cout == conf(~qo, TS)
		reduce(~cin) = some(~cout)
		TTC |- ~qi : TT
		StoreContextConsistent(~TS, ~TTC)
		====================================== sql2-Progress
		exists ~cout
			reduce(q2, TS) == some(~cout)
		
		axiom 
		~sqli == q2
		~cin == conf(~qi, TS)
		~cout == conf(~qo, TS)
		reduce(~cin) = some(~cout)
		TTC |- ~qi : TT
		StoreContextConsistent(~TS, ~TTC)
		================================ SQL-Preservation-T-Union-IH2
		TS |- ~qo : TT
		
		goal 
		~qi == Union(Tvalue(~t1), q2)
		forall ~t2 q2 != Tvalue(~t2)
		~cin == conf(~qi, TS)
		~cout == conf(~qo, TS)
		reduce(~cin) = some(~cout)
		TTC |- ~qi : TT
		StoreContextConsistent(~TS, ~TTC)
		========================================== SQL-Preservation-T-Union-2
		TS |- ~qo : TT	
	}
	
	axiom 
	~qi == Union(Tvalue(~t1), q2)
	forall ~t2 q2 != Tvalue(~t2)
	~cin == conf(~qi, TS)
	~cout == conf(~qo, TS)
	reduce(~cin) = some(~cout)
	TTC |- ~qi : TT
	StoreContextConsistent(~TS, ~TTC)
	========================================== SQL-Preservation-T-Union-2
	TS |- ~qo : TT	
	
	local {
		
		axiom 
		~qi == q1
		~cin == conf(~qi, TS)
		~cout == conf(~qo, TS)
		reduce(~cin) = some(~cout)
		TTC |- ~qi : TT
		StoreContextConsistent(~TS, ~TTC)
		================================ SQL-Preservation-T-Union-IH1
		TS |- ~qo : TT
		
		goal 
		~qi == Union(q1, q2)
		forall ~t1 q1 != Tvalue(~t1)
		~cin == conf(~qi, TS)
		~cout == conf(~qo, TS)
		reduce(~cin) = some(~cout)
		TTC |- ~qi : TT
		StoreContextConsistent(~TS, ~TTC)
		========================================== SQL-Preservation-T-Union-3
		TS |- ~qo : TT	
	}
	
	axiom 
	~qi == Union(q1, q2)
	forall ~t1 q1 != Tvalue(~t1)
	~cin == conf(~qi, TS)
	~cout == conf(~qo, TS)
	reduce(~cin) = some(~cout)
	TTC |- ~qi : TT
	StoreContextConsistent(~TS, ~TTC)
	========================================== SQL-Preservation-T-Union-3
	TS |- ~qo : TT	
		
	goal 
	~qi == Union(q1, q2)
	~cin == conf(~qi, TS)
	~cout == conf(~qo, TS)
	reduce(~cin) = some(~cout)
	TTC |- ~qi : TT
	StoreContextConsistent(~TS, ~TTC)
	================================ SQL-Preservation-T-Union
	TS |- ~qo : TT
}
// // 
// // local {
// // 	consts sql1 : SQLExp
// // 		sql2 : SQLExp
// // 		TS : TStore
// // 		TT : TType
// // 	
// // 	axiom 
// // 	~cin == conf(sql1, TS)
// // 	~cout == conf(~sqlo, TS)
// // 	reduce(~cin) = some(~cout)
// // 	TS |- ~sqli : TT
// // 	================================ SQL-Preservation-T-Intersection-IH1
// // 	TS |- ~sqlo : TT
// // 	
// // 	axiom 
// // 	~cin == conf(sql2, TS)
// // 	~cout == conf(~sqlo, TS)
// // 	reduce(~cin) = some(~cout)
// // 	TS |- ~sqli : TT
// // 	================================ SQL-Preservation-T-Intersection-IH2
// // 	TS |- ~sqlo : TT
// // 		
// // 	goal 
// // 	~sqli == Intersection(sql1, sql2)
// // 	~cin == conf(~sqli, TS)
// // 	~cout == conf(~sqlo, TS)
// // 	reduce(~cin) = some(~cout)
// // 	TS |- ~sqli : TT
// // 	================================ SQL-Preservation-T-Intersection
// // 	TS |- ~sqlo : TT
// // }
// // 
// // 
// // local {
// // 	consts sql1 : SQLExp
// // 		sql2 : SQLExp
// // 		TS : TStore
// // 		TT : TType
// // 	
// // 	axiom 
// // 	~cin == conf(sql1, TS)
// // 	~cout == conf(~sqlo, TS)
// // 	reduce(~cin) = some(~cout)
// // 	TS |- ~sqli : TT
// // 	================================ SQL-Preservation-T-Difference-IH1
// // 	TS |- ~sqlo : TT
// // 	
// // 	axiom 
// // 	~cin == conf(sql2, TS)
// // 	~cout == conf(~sqlo, TS)
// // 	reduce(~cin) = some(~cout)
// // 	TS |- ~sqli : TT
// // 	================================ SQL-Preservation-T-Difference-IH2
// // 	TS |- ~sqlo : TT
// // 		
// // 	goal 
// // 	~sqli == Difference(sql1, sql2)
// // 	~cin == conf(~sqli, TS)
// // 	~cout == conf(~sqlo, TS)
// // 	reduce(~cin) = some(~cout)
// // 	TS |- ~sqli : TT
// // 	================================ SQL-Preservation-T-Difference
// // 	TS |- ~sqlo : TT
// // }
// 
//final preservation theorem
//for now: restricted to the case where table store (and context) does not change!
axiom
~cin == conf(~qi, ~TS)
~cout == conf(~qo, ~TS)
reduce(~cin) = some(~cout)
~TTC |- ~qi : ~TT
StoreContextConsistent(~TS, ~TTC)
=================================== SQL-Preservation
~TTC |- ~qo : ~TT