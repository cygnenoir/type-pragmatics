module sql.TableAux

import sql.Tables

//some auxiliary functions on raw tables (all not knowing anything about table types!)
//the functions are intended to be used with well-typed tables!!

function 
rowIn : Row RawTable -> Bool
rowIn(r1, tempty) = false
rowIn(r1, tcons(r2, rt)) = (r1 == r2) || rowIn(r1, rt)

//projects a raw table to its first column
//returns a raw table with exactly one column or tempty	
function
projectFirstRaw : RawTable -> RawTable
projectFirstRaw(tempty) = tempty
projectFirstRaw(tcons(rempty, rt)) = tcons(rempty, projectFirstRaw(rt))
projectFirstRaw(tcons(rcons(f, r), rt)) = tcons(rcons(f, rempty), projectFirstRaw(rt))


//drops the first column of a raw table
//returns a raw table with one column less than before or tempty
function
dropFirstColRaw : RawTable -> RawTable
dropFirstColRaw(tempty) = tempty
dropFirstColRaw(tcons(rempty, rt)) = tcons(rempty, dropFirstColRaw(rt))
dropFirstColRaw(tcons(rcons(f, r), rt)) = tcons(r, dropFirstColRaw(rt)) 

//attaches a raw table with one column to the front of another raw table
//returns a raw table with one column more
//assumes that both tables have the same row count!
//has to be partial, not every case is covered!
partial function
attachColToFrontRaw : RawTable RawTable -> RawTable
//second arg t should be tempty normally!
attachColToFrontRaw(tempty, t) = tempty
attachColToFrontRaw(tcons(rcons(f, rempty), rt1), tcons(r, rt2)) = 
	tcons(rcons(f, r), attachColToFrontRaw(rt1, rt2))

//definition: union removes duplicate rows
//(but only between the two tables, not within a table!)
//preserves row order of the two original raw tables
function
rawUnion : RawTable RawTable -> RawTable
rawUnion(tempty, rt2) = rt2
rawUnion(rt1, tempty) = rt1
rawUnion(tcons(r1, tempty), rt2) = 
	if (!rowIn(r1, rt2))
	then tcons(r1, rt2)
	else rt2
rawUnion(tcons(r1, rt1), rt2) =
	let urt1rt2 = rawUnion(rt1, rt2) in
		if (!rowIn(r1, rt2))
		then tcons(r1, urt1rt2)
		else urt1rt2
		
//preserves order of rows in first argument
function
rawIntersection : RawTable RawTable -> RawTable
rawIntersection(tempty, rt2) = tempty
rawIntersection(rt1, tempty) = tempty
rawIntersection(tcons(r1, tempty), rt2) = 
	if (rowIn(r1, rt2))
	then tcons(r1, tempty)
	else tempty
rawIntersection(tcons(r1, rt1), rt2) =
	let urt1rt2 = rawIntersection(rt1, rt2) in
		if (rowIn(r1, rt2))
		then tcons(r1, urt1rt2)
		else urt1rt2
		
function
rawDifference : RawTable RawTable -> RawTable
rawDifference(tempty, rt2) = tempty
rawDifference(rt1, tempty) = rt1
rawDifference(tcons(r1, tempty), rt2) =
	if (!rowIn(r1, rt2))
	then tcons(r1, tempty)
	else tempty
rawDifference(tcons(r1, rt1), rt2) =
	let drt1rt2 = rawDifference(rt1, rt2) in
		if (!rowIn(r1, rt2))
		then tcons(r1, drt1rt2)
		else drt1rt2
		
//some tests of the raw table functions
goal
~rt = tcons(rcons(~x1, rcons(~y2, rcons(~z2, rempty))), 
	tcons(rcons(~x2, rcons(~y1, rcons(~z1, rempty))), 
	tcons(rcons(~x2, rcons(~y2, rcons(~z1, rempty))), 
	tcons(rcons(~x1, rcons(~y1, rcons(~z1, rempty))),
	tcons(rcons(~x1, rcons(~y2, rcons(~z1, rempty))),
	tcons(rcons(~x2, rcons(~y2, rcons(~z2, rempty))), tempty))))))
~r = rcons(~x1, rcons(~y2, rcons(~z1, rempty)))
========================================================== test-rowIn
rowIn(~r, ~rt)

local {
	constructors
		x1 : FVal
		x2 : FVal
	
	goal 
	~rt == tcons(rcons(x1, rcons(x2, rempty)), tempty)
	~r == rcons(x1, rcons(x1, rempty))
	========================================= test-notrowIn0
	!rowIn(~r, ~rt)
	
}

local {
	
	constructors 
		x1 : FVal
		x2 : FVal
		y1 : FVal
		y2 : FVal
		z1 : FVal
		z2 : FVal

	goal
	~rt == tcons(rcons(x1, rcons(y2, rcons(z2, rempty))), 
		tcons(rcons(x2, rcons(y1, rcons(z1, rempty))), tempty))
	~r == rcons(x1, rcons(y2, rcons(z1, rempty)))
	========================================================== test-notrowIn1
	!rowIn(~r, ~rt)
}


local {
	
	constructors 
		x1 : FVal
		x2 : FVal
		y1 : FVal
		y2 : FVal
		z1 : FVal
		z2 : FVal

	goal
	~rt == tcons(rcons(x1, rcons(y2,  rcons(z2, rempty))), 
		tcons(rcons(x2, rcons(y1, rcons(z1, rempty))), 
		tcons(rcons(x2, rcons(y2, rcons(z1, rempty))), 
		tcons(rcons(x1, rcons(y1, rcons(z1, rempty))),
		tcons(rcons(x2, rcons(y2, rcons(z2, rempty))), tempty)))))
	~r == rcons(x1, rcons(y2, rcons(z1, rempty)))
	========================================================== test-notrowIn2
	!rowIn(~r, ~rt)
}


goal
~rt = tcons(rcons(~x1, rcons(~y2,   rcons(~z2, rempty))), 
	tcons(rcons(~x2, rcons(~y1, rcons(~z1, rempty))), 
	tcons(rcons(~x2, rcons(~y2, rcons(~z1, rempty))), 
	tcons(rcons(~x1, rcons(~y1, rcons(~z1, rempty))),
	tcons(rcons(~x1, rcons(~y2, rcons(~z1, rempty))),
	tcons(rcons(~x2, rcons(~y2, rcons(~z2, rempty))), tempty))))))
~prt = tcons( rcons(~x1, rempty),
	tcons(rcons(~x2, rempty),
	tcons(rcons(~x2, rempty),
	tcons(rcons(~x1, rempty),
	tcons(rcons(~x1, rempty),
	tcons(rcons(~x2, rempty), tempty))))))
========================================================== test-projectFirstRaw
projectFirstRaw(~rt) == ~prt

goal
~prt = tcons( rcons(~x1, rempty),
	tcons(rcons(~x2, rempty),
	tcons(rcons(~x2, rempty),
	tcons(rcons(~x1, rempty),
	tcons(rcons(~x1, rempty),
	tcons(rcons(~x2, rempty), tempty))))))
==================================== test-projectFirstRaw1
projectFirstRaw(~prt) == ~prt

goal
~rt = tcons(rcons(~x1, rcons(~y2,   rcons(~z2, rempty))), 
	tcons(rcons(~x2, rcons(~y1, rcons(~z1, rempty))), 
	tcons(rcons(~x2, rcons(~y2, rcons(~z1, rempty))), 
	tcons(rcons(~x1, rcons(~y1, rcons(~z1, rempty))),
	tcons(rcons(~x1, rcons(~y2, rcons(~z1, rempty))),
	tcons(rcons(~x2, rcons(~y2, rcons(~z2, rempty))), tempty))))))
~drt = tcons(rcons(~y2,  rcons(~z2, rempty)),
	tcons(rcons(~y1, rcons(~z1, rempty)),
	tcons(rcons(~y2, rcons(~z1, rempty)),
	tcons(rcons(~y1, rcons(~z1, rempty)),
	tcons(rcons(~y2, rcons(~z1, rempty)),
	tcons(rcons(~y2, rcons(~z2, rempty)), tempty))))))
========================================================== test-dropFirstColRaw
dropFirstColRaw(~rt) == ~drt

goal
~prt = tcons( rcons(~x1, rempty),
	tcons(rcons(~x2, rempty), tempty))
~drt = tcons(rcons(~y2,  rcons(~z2, rempty)),
	tcons(rcons(~y1, rcons(~z1, rempty)), tempty))
~rt = tcons(rcons(~x1, rcons(~y2,   rcons(~z2, rempty))), 
	tcons(rcons(~x2, rcons(~y1, rcons(~z1, rempty))), tempty))
========================================================== test-attachColToFrontRaw1
attachColToFrontRaw(~prt, ~drt) == ~rt

goal
~prt = tcons( rcons(~x1, rempty),
	tcons(rcons(~x2, rempty),
	tcons(rcons(~x2, rempty), tempty)))
~drt = tcons(rcons(~y2,  rcons(~z2, rempty)),
	tcons(rcons(~y1, rcons(~z1, rempty)),
	tcons(rcons(~y2, rcons(~z1, rempty)), tempty)))
~rt = tcons(rcons(~x1, rcons(~y2,   rcons(~z2, rempty))), 
	tcons(rcons(~x2, rcons(~y1, rcons(~z1, rempty))), 
	tcons(rcons(~x2, rcons(~y2, rcons(~z1, rempty))), tempty)))
========================================================== test-attachColToFrontRaw3
attachColToFrontRaw(~prt, ~drt) == ~rt

goal
~prt = tcons( rcons(~x1, rempty),
	tcons(rcons(~x2, rempty),
	tcons(rcons(~x2, rempty),
	tcons(rcons(~x1, rempty), tempty))))
~drt = tcons(rcons(~y2,  rcons(~z2, rempty)),
	tcons(rcons(~y1, rcons(~z1, rempty)),
	tcons(rcons(~y2, rcons(~z1, rempty)),
	tcons(rcons(~y1, rcons(~z1, rempty)), tempty))))
~rt = tcons(rcons(~x1, rcons(~y2,   rcons(~z2, rempty))), 
	tcons(rcons(~x2, rcons(~y1, rcons(~z1, rempty))), 
	tcons(rcons(~x2, rcons(~y2, rcons(~z1, rempty))), 
	tcons(rcons(~x1, rcons(~y1, rcons(~z1, rempty))), tempty))))
========================================================== test-attachColToFrontRaw4
attachColToFrontRaw(~prt, ~drt) == ~rt

goal
~prt = tcons(rcons(~y2,  rcons(~z2, rempty)),
	tcons(rcons(~y1, rcons(~z1, rempty)),
	tcons(rcons(~y2, rcons(~z1, rempty)),
	tcons(rcons(~y1, rcons(~z1, rempty)), tempty))))
~drt = tcons(rcons(~y2,  rcons(~z2, rempty)),
	tcons(rcons(~y1, rcons(~z1, rempty)),
	tcons(rcons(~y2, rcons(~z1, rempty)),
	tcons(rcons(~y1, rcons(~z1, rempty)), tempty))))
~rt = tcons(rcons(~y2,   rcons(~z2, rempty)), 
	tcons(rcons(~y1, rcons(~z1, rempty)), 
	tcons(rcons(~y2, rcons(~z1, rempty)), 
	tcons(rcons(~y1, rcons(~z1, rempty)), tempty))))
========================================================== test-rawUnion1
rawUnion(~prt, ~drt) == ~rt

// goal
// ~prt = tcons(rcons(~y2, rone(~z2)), tempty)
// ~drt = tcons(rcons(~y1, rone(~z1)),
// 	tcons(rcons(~y2, rone(~z1)),
// 	tcons(rcons(~y1, rone(~z1)), tempty)))
// ~rt = tcons(rcons(~y2, rone(~z2)), 
// 	tcons(rcons(~y1, rone(~z1)), 
// 	tcons(rcons(~y2, rone(~z1)), 
// 	tcons(rcons(~y1, rone(~z1)), tempty))))
// ~z1 != ~z2
// ~y1 != ~y2
// ~x1 != ~x2
// ========================================================== test-rawUnion2
// rawUnion(~prt, ~drt) == ~rt

local {
	constructors 
		y1 : FVal
		y2 : FVal
		z1 : FVal
		z2 : FVal
	goal
	~prt = tcons(rcons(y2,  rcons(z2, rempty)), tempty)
	~drt = tcons(rcons(y1,  rcons(z1, rempty)),
		tcons(rcons(y2, rcons(z1, rempty)),
		tcons(rcons(y1, rcons(z1, rempty)), tempty)))
	~rt = tcons(rcons(y2,   rcons(z2, rempty)), 
		tcons(rcons(y1, rcons(z1, rempty)), 
		tcons(rcons(y2, rcons(z1, rempty)), 
		tcons(rcons(y1, rcons(z1, rempty)), tempty))))
	========================================================== test-rawUnion2
	rawUnion(~prt, ~drt) == ~rt
}

// goal
// ~prt = tcons(rcons(~y2, rone(~z2)), 
// 	tcons(rcons(~y2, rone(~z1)), tempty))
// ~drt = tcons(rcons(~y1, rone(~z1)),
// 	tcons(rcons(~y2, rone(~z1)),
// 	tcons(rcons(~y1, rone(~z1)), tempty)))
// ~rt = tcons(rcons(~y2, rone(~z2)), 
// 	tcons(rcons(~y1, rone(~z1)), 
// 	tcons(rcons(~y2, rone(~z1)), 
// 	tcons(rcons(~y1, rone(~z1)), tempty))))
// ~z1 != ~z2
// ~y1 != ~y2
// ~x1 != ~x2
// ========================================================== test-rawUnion3
// rawUnion(~prt, ~drt) == ~rt

local {
	
	constructors 
		y1 : FVal
		y2 : FVal
		z1 : FVal
		z2 : FVal
		
	goal
	~prt = tcons(rcons(y2,  rcons(z2, rempty)), 
		tcons(rcons(y2, rcons(z1, rempty)), tempty))
	~drt = tcons(rcons(y1,  rcons(z1, rempty)),
		tcons(rcons(y2, rcons(z1, rempty)),
		tcons(rcons(y1, rcons(z1, rempty)), tempty)))
	~rt = tcons(rcons(y2,   rcons(z2, rempty)), 
		tcons(rcons(y1, rcons(z1, rempty)), 
		tcons(rcons(y2, rcons(z1, rempty)), 
		tcons(rcons(y1, rcons(z1, rempty)), tempty))))
	========================================================== test-rawUnion3
	rawUnion(~prt, ~drt) == ~rt
}

goal
~prt = tcons(rcons(~y2,  rcons(~z2, rempty)),
	tcons(rcons(~y1, rcons(~z1, rempty)),
	tcons(rcons(~y2, rcons(~z1, rempty)),
	tcons(rcons(~y1, rcons(~z1, rempty)), tempty))))
~drt = tcons(rcons(~y2,  rcons(~z2, rempty)),
	tcons(rcons(~y1, rcons(~z1, rempty)),
	tcons(rcons(~y2, rcons(~z1, rempty)),
	tcons(rcons(~y1, rcons(~z1, rempty)), tempty))))
~rt = tcons(rcons(~y2,   rcons(~z2, rempty)), 
	tcons(rcons(~y1, rcons(~z1, rempty)), 
	tcons(rcons(~y2, rcons(~z1, rempty)), 
	tcons(rcons(~y1, rcons(~z1, rempty)), tempty))))
========================================================== test-rawIntersection1
rawIntersection(~prt, ~drt) == ~rt

// goal
// ~prt = tcons(rcons(~y2, rone(~z2)), tempty)
// ~drt = tcons(rcons(~y1, rone(~z1)),
// 	tcons(rcons(~y2, rone(~z1)),
// 	tcons(rcons(~y1, rone(~z1)), tempty)))
// ~z1 != ~z2
// ~y1 != ~y2
// ~x1 != ~x2
// ========================================================== test-rawIntersection2
// rawIntersection(~prt, ~drt) == tempty

local {
	
	constructors 
		y1 : FVal
		y2 : FVal
		z1 : FVal
		z2 : FVal
		
	goal
	~prt = tcons(rcons(y2,  rcons(z2, rempty)), tempty)
	~drt = tcons(rcons(y1,  rcons(z1, rempty)),
		tcons(rcons(y2, rcons(z1, rempty)),
		tcons(rcons(y1, rcons(z1, rempty)), tempty)))
	========================================================== test-rawIntersection2
	rawIntersection(~prt, ~drt) == tempty
}

// goal
// ~prt = tcons(rcons(~y2, rone(~z2)), 
// 	tcons(rcons(~y2, rone(~z1)), tempty))
// ~drt = tcons(rcons(~y1, rone(~z1)),
// 	tcons(rcons(~y2, rone(~z1)),
// 	tcons(rcons(~y1, rone(~z1)), tempty)))
// ~rt = tcons(rcons(~y2, rone(~z1)), tempty)
// ~z1 != ~z2
// ~y1 != ~y2
// ~x1 != ~x2
// ========================================================== test-rawIntersection3
// rawIntersection(~prt, ~drt) == ~rt

// requires 120 timeout! (needs between 70-80 seconds to prove!)
local {
	
	constructors 
		y1 : FVal
		y2 : FVal
		z1 : FVal
		z2 : FVal

	goal
	~prt = tcons(rcons(y2,  rcons(z2, rempty)), 
		tcons(rcons(y2, rcons(z1, rempty)), tempty))
	~drt = tcons(rcons(y1,  rcons(z1, rempty)),
		tcons(rcons(y2, rcons(z1, rempty)),
		tcons(rcons(y1, rcons(z1, rempty)), tempty)))
	~rt = tcons(rcons(y2,   rcons(z1, rempty)), tempty)
	========================================================== test-rawIntersection3
	rawIntersection(~prt, ~drt) == ~rt
}

goal
~prt = tcons(rcons(~y2,  rcons(~z2, rempty)),
	tcons(rcons(~y1, rcons(~z1, rempty)),
	tcons(rcons(~y2, rcons(~z1, rempty)),
	tcons(rcons(~y1, rcons(~z1, rempty)), tempty))))
~drt = tcons(rcons(~y2,  rcons(~z2, rempty)),
	tcons(rcons(~y1, rcons(~z1, rempty)),
	tcons(rcons(~y2, rcons(~z1, rempty)),
	tcons(rcons(~y1, rcons(~z1, rempty)), tempty))))
========================================================== test-rawDifference1
rawDifference(~prt, ~drt) == tempty

local {
	
	constructors 
		y1 : FVal
		y2 : FVal
		z1 : FVal
		z2 : FVal
		
	goal
	~prt = tcons(rcons(y2,  rcons(z2, rempty)), tempty)
	~drt = tcons(rcons(y1,  rcons(z1, rempty)),
		tcons(rcons(y2, rcons(z1, rempty)),
		tcons(rcons(y1, rcons(z1, rempty)), tempty)))
	========================================================== test-rawDifference2
	rawDifference(~prt, ~drt) == ~prt
}


local {
	
	constructors 
		y1 : FVal
		y2 : FVal
		z1 : FVal
		z2 : FVal

	goal
	~prt = tcons(rcons(y2,  rcons(z2, rempty)), 
		tcons(rcons(y2, rcons(z1, rempty)), tempty))
	~drt = tcons(rcons(y1,  rcons(z1, rempty)),
		tcons(rcons(y2, rcons(z1, rempty)),
		tcons(rcons(y1, rcons(z1, rempty)), tempty)))
	~rt = tcons(rcons(y2,   rcons(z2, rempty)), tempty)
	========================================================== test-rawDifference3
	rawDifference(~prt, ~drt) == ~rt
}

